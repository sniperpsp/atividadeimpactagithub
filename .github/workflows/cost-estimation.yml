# ==============================================================================
# CI/CD Pipeline - Cost Estimation (Scheduled)
# ==============================================================================
# Monitora custos da infraestrutura usando Infracost
# - Estimativa de custos mensais
# - ComparaÃ§Ã£o com baseline
# - Alertas de aumento de custos
# ==============================================================================

name: 'Cost Estimation'

on:
  schedule:
    # Executa semanalmente Ã s segundas-feiras Ã s 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'terraform/**'

env:
  TF_VERSION: '1.6.0'
  TF_WORKING_DIR: './terraform'
  AWS_REGION: 'us-east-2'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==============================================================================
  # Job 1: Cost Estimation
  # ==============================================================================
  infracost:
    name: 'Infracost Analysis'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Infracost'
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 'Terraform Init'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: 'Generate Infracost JSON'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          infracost breakdown --path . \
            --terraform-var-file=environments/prod.tfvars \
            --format json \
            --out-file /tmp/infracost-base.json

      - name: 'Generate Infracost Diff (for PRs)'
        if: github.event_name == 'pull_request'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          git checkout ${{ github.event.pull_request.base.ref }}
          terraform init
          infracost breakdown --path . \
            --terraform-var-file=environments/prod.tfvars \
            --format json \
            --out-file /tmp/infracost-baseline.json
          
          git checkout ${{ github.event.pull_request.head.ref }}
          terraform init
          
          infracost diff \
            --path . \
            --terraform-var-file=environments/prod.tfvars \
            --compare-to /tmp/infracost-baseline.json \
            --format json \
            --out-file /tmp/infracost-diff.json

      - name: 'Post Infracost Comment (PR)'
        if: github.event_name == 'pull_request'
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost-diff.json
          behavior: update

      - name: 'Generate Cost Report'
        run: |
          infracost output --path /tmp/infracost-base.json --format table > cost-report.txt
          infracost output --path /tmp/infracost-base.json --format html > cost-report.html

      - name: 'Upload Cost Reports'
        uses: actions/upload-artifact@v4
        with:
          name: cost-reports-${{ github.sha }}
          path: |
            cost-report.txt
            cost-report.html
            /tmp/infracost-base.json
          retention-days: 90

      - name: 'Extract Cost Summary'
        id: cost
        run: |
          MONTHLY_COST=$(jq -r '.totalMonthlyCost' /tmp/infracost-base.json)
          echo "monthly_cost=$MONTHLY_COST" >> $GITHUB_OUTPUT
          echo "Monthly Cost: \$$MONTHLY_COST"

      - name: 'Create Cost Summary'
        run: |
          echo "## ðŸ’° Infrastructure Cost Estimation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Monthly Cost:** \$${{ steps.cost.outputs.monthly_cost }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat cost-report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: 'Check Cost Threshold'
        id: threshold
        run: |
          THRESHOLD=150
          COST=${{ steps.cost.outputs.monthly_cost }}
          
          if (( $(echo "$COST > $THRESHOLD" | bc -l) )); then
            echo "âš ï¸ Cost exceeds threshold of \$$THRESHOLD"
            echo "exceeded=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Cost within threshold"
            echo "exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Create Cost Alert Issue'
        if: steps.threshold.outputs.exceeded == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cost = '${{ steps.cost.outputs.monthly_cost }}';
            const threshold = 150;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ’° Cost Alert: Monthly estimate exceeds $${threshold}`,
              body: `## Cost Threshold Exceeded
              
              **Current Estimated Monthly Cost:** $${cost}
              **Threshold:** $${threshold}
              **Overage:** $${(parseFloat(cost) - threshold).toFixed(2)}
              
              ### Action Required
              
              The infrastructure cost estimate has exceeded the defined threshold. Please review the cost breakdown and consider optimization opportunities.
              
              ### Cost Breakdown
              
              View the detailed cost report in the [workflow artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId}).
              
              ### Optimization Suggestions
              
              1. Review instance types and sizes
              2. Check for unused resources
              3. Consider Reserved Instances or Savings Plans
              4. Optimize storage usage
              5. Review data transfer costs
              
              **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              labels: ['cost-optimization', 'infrastructure', 'review-needed']
            });
            
            console.log(`Created cost alert issue #${issue.data.number}`);

  # ==============================================================================
  # Job 2: Cost Trends Analysis
  # ==============================================================================
  trends:
    name: 'Cost Trends'
    runs-on: ubuntu-latest
    needs: infracost
    if: github.event_name == 'schedule'
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Download Previous Cost Data'
        uses: actions/download-artifact@v4
        with:
          name: cost-reports-${{ github.sha }}
        continue-on-error: true

      - name: 'Analyze Cost Trends'
        run: |
          echo "## ðŸ“Š Cost Trends Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Historical Data" >> $GITHUB_STEP_SUMMARY
          echo "Cost trend analysis requires multiple data points." >> $GITHUB_STEP_SUMMARY
          echo "This feature will become more useful over time as historical data accumulates." >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Job 3: FinOps Recommendations
  # ==============================================================================
  finops:
    name: 'FinOps Recommendations'
    runs-on: ubuntu-latest
    needs: infracost
    
    steps:
      - name: 'Generate FinOps Recommendations'
        run: |
          cat > finops-recommendations.md << 'EOF'
          # ðŸ’° FinOps Recommendations for QuickOrder Infrastructure
          
          ## Current Optimization Strategies
          
          ### 1. Compute Optimization
          - âœ… Using t3.micro instances for cost efficiency
          - âœ… EKS nodes using SPOT instances (up to 90% savings)
          - ðŸ’¡ Consider Reserved Instances for stable workloads (up to 72% savings)
          
          ### 2. Database Optimization
          - âœ… RDS Single-AZ deployment for non-critical environments
          - ðŸ’¡ Consider Aurora Serverless for variable workloads
          - ðŸ’¡ Enable automated backups with appropriate retention
          
          ### 3. Network Optimization
          - âœ… Single NAT Gateway (saves ~$33/month)
          - âš ï¸ Trade-off: Reduced availability if AZ fails
          - ðŸ’¡ Consider NAT instances for further cost reduction
          
          ### 4. Storage Optimization
          - ðŸ’¡ Implement S3 lifecycle policies
          - ðŸ’¡ Use S3 Intelligent-Tiering for automatic cost optimization
          - ðŸ’¡ Enable S3 versioning with expiration rules
          
          ### 5. Monitoring & Alerts
          - âœ… CloudWatch for basic monitoring
          - ðŸ’¡ Set up cost anomaly detection
          - ðŸ’¡ Configure billing alerts
          
          ## Monthly Cost Targets
          
          | Service | Current | Target | Optimization |
          |---------|---------|--------|--------------|
          | EC2 | ~$15 | ~$10 | Reserved Instances |
          | EKS | ~$103 | ~$80 | Spot + Right-sizing |
          | NAT Gateway | ~$32 | ~$0 | NAT Instance |
          | RDS | ~$15 | ~$12 | Reserved Instance |
          | Total | ~$165 | ~$102 | 38% reduction |
          
          ## Action Items
          
          1. **Immediate (0-30 days)**
             - Review and remove unused resources
             - Enable cost allocation tags
             - Set up billing alerts
          
          2. **Short-term (1-3 months)**
             - Analyze Reserved Instance opportunities
             - Implement auto-scaling policies
             - Optimize storage lifecycle
          
          3. **Long-term (3-6 months)**
             - Consider Savings Plans
             - Evaluate multi-region strategy
             - Implement advanced cost optimization
          
          EOF
          
          cat finops-recommendations.md

      - name: 'Upload FinOps Report'
        uses: actions/upload-artifact@v4
        with:
          name: finops-recommendations
          path: finops-recommendations.md
          retention-days: 90

      - name: 'Add to Summary'
        run: |
          cat finops-recommendations.md >> $GITHUB_STEP_SUMMARY
