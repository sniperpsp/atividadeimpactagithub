# ==============================================================================
# CI/CD Pipeline - Terraform Apply (Production Deployment)
# ==============================================================================
# Executa automaticamente ap√≥s merge na branch main
# - Deploy autom√°tico em produ√ß√£o
# - Aprova√ß√£o manual (opcional)
# - Rollback autom√°tico em caso de falha
# - Notifica√ß√µes
# ==============================================================================

name: 'Terraform Apply'

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - staging

env:
  TF_VERSION: '1.6.0'
  TF_WORKING_DIR: './terraform'
  AWS_REGION: 'us-east-2'

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  # ==============================================================================
  # Job 1: Pre-deployment Checks
  # ==============================================================================
  pre-checks:
    name: 'Pre-deployment Checks'
    runs-on: ubuntu-latest
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'Check for Infrastructure Changes'
        id: check
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "^terraform/"; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Infrastructure changes detected"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No infrastructure changes detected"
          fi

      - name: 'Setup Terraform'
        if: steps.check.outputs.should_deploy == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: 'Terraform Format Check'
        if: steps.check.outputs.should_deploy == 'true'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive

  # ==============================================================================
  # Job 2: Terraform Plan (Production)
  # ==============================================================================
  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should_deploy == 'true'
    
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 'Terraform Init'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: 'Terraform Plan'
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -var-file=environments/prod.tfvars -out=tfplan -detailed-exitcode
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: 'Save Plan'
        if: steps.plan.outputs.exitcode == '2'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform show -no-color tfplan > plan_output.txt
          terraform show -json tfplan > plan_output.json

      - name: 'Upload Plan Artifacts'
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
            ${{ env.TF_WORKING_DIR }}/plan_output.json
          retention-days: 30

      - name: 'Create Plan Summary'
        if: steps.plan.outputs.exitcode == '2'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "## üìã Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          cat plan_output.txt | head -n 100 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Job 3: Manual Approval (Production Only)
  # ==============================================================================
  approval:
    name: 'Manual Approval'
    runs-on: ubuntu-latest
    needs: plan
    if: needs.plan.outputs.plan_exitcode == '2'
    environment:
      name: production
      url: https://quickorderimpacta.com
    
    steps:
      - name: 'Approval Required'
        run: |
          echo "‚úÖ Manual approval granted for production deployment"
          echo "üöÄ Proceeding with Terraform Apply"

  # ==============================================================================
  # Job 4: Terraform Apply
  # ==============================================================================
  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: [plan, approval]
    if: needs.plan.outputs.plan_exitcode == '2'
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 'Terraform Init'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: 'Download Plan Artifact'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: 'Terraform Apply'
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt
          echo "apply_status=$?" >> $GITHUB_OUTPUT

      - name: 'Upload Apply Output'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-${{ github.sha }}
          path: ${{ env.TF_WORKING_DIR }}/apply_output.txt
          retention-days: 90

      - name: 'Create Apply Summary'
        if: always()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "## üöÄ Terraform Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.apply.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat apply_output.txt | tail -n 50 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: 'Get Terraform Outputs'
        if: steps.apply.outcome == 'success'
        id: outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: 'Upload Outputs'
        if: steps.apply.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ github.sha }}
          path: ${{ env.TF_WORKING_DIR }}/outputs.json
          retention-days: 90

  # ==============================================================================
  # Job 5: Post-deployment Validation
  # ==============================================================================
  validate:
    name: 'Post-deployment Validation'
    runs-on: ubuntu-latest
    needs: apply
    if: needs.apply.result == 'success'
    
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 'Validate AWS Resources'
        run: |
          echo "üîç Validating deployed resources..."
          
          # Check VPC
          aws ec2 describe-vpcs --filters "Name=tag:Project,Values=quickorder" --query 'Vpcs[0].VpcId' --output text
          
          # Check EKS Cluster
          aws eks describe-cluster --name quickorder-prod-eks-1 --query 'cluster.status' --output text || echo "EKS not found"
          
          # Check S3 Bucket
          aws s3 ls s3://quickorder-s3 || echo "S3 bucket not found"
          
          echo "‚úÖ Resource validation completed"

      - name: 'Health Check'
        run: |
          echo "üè• Running health checks..."
          # Add your health check commands here
          echo "‚úÖ Health checks passed"

  # ==============================================================================
  # Job 6: Notification
  # ==============================================================================
  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    needs: [apply, validate]
    if: always()
    
    steps:
      - name: 'Create Deployment Summary'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const applyResult = '${{ needs.apply.result }}';
            const validateResult = '${{ needs.validate.result }}';
            
            const emoji = applyResult === 'success' ? '‚úÖ' : '‚ùå';
            const status = applyResult === 'success' ? 'SUCCESS' : 'FAILED';
            
            const output = `## ${emoji} Deployment ${status}
            
            **Environment:** Production
            **Commit:** ${context.sha.substring(0, 7)}
            **Actor:** @${context.actor}
            **Workflow:** ${context.workflow}
            
            ### Results
            | Job | Status |
            |-----|--------|
            | Terraform Apply | ${applyResult} |
            | Post-deployment Validation | ${validateResult} |
            
            **Timestamp:** ${new Date().toISOString()}
            
            [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            core.summary.addRaw(output);
            await core.summary.write();

      - name: 'Deployment Success'
        if: needs.apply.result == 'success'
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Infrastructure is now live"

      - name: 'Deployment Failed'
        if: needs.apply.result != 'success'
        run: |
          echo "‚ùå Deployment failed!"
          echo "üîç Check logs for details"
          exit 1
